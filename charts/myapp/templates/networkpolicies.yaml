{{- /*
NetworkPolicies for microservice-a, microservice-b and Postgres
This file defines secure, namespace-scoped rules.
*/ -}}

# Allow ingress from OpenShift routers (external access) to microservice-a
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-ingress-to-micro-a
  namespace: santiago-parraga-2-dev
spec:
  podSelector:
    matchLabels:
      app: microservice-a
  policyTypes:
    - Ingress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              network.openshift.io/policy-group: ingress
      ports:
        - protocol: TCP
          port: {{ .Values.microserviceA.port }}

---

# Allow microservice-a to call microservice-b
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-a-to-b
  namespace: santiago-parraga-2-dev
spec:
  podSelector:
    matchLabels:
      app: microservice-b
  policyTypes:
    - Ingress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: santiago-parraga-2-dev
          podSelector:
            matchLabels:
              app: microservice-a
      ports:
        - protocol: TCP
          port: {{ .Values.microserviceB.port }}

---

# Allow microservice-b to connect to Postgres
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-b-to-postgres
  namespace: santiago-parraga-2-dev
spec:
  podSelector:
    matchLabels:
      app: postgres
  policyTypes:
    - Ingress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: santiago-parraga-2-dev
          podSelector:
            matchLabels:
              app: microservice-b
      ports:
        - protocol: TCP
          port: 5432

