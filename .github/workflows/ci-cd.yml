name: CI-CD

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      - name: Build microservice-a
        run: |
          cd microservice-a
          mvn -DskipTests package
      - name: Build microservice-b
        run: |
          cd microservice-b
          mvn -DskipTests package
      - name: Login to registry
        env:
          REGISTRY: ${{ secrets.REGISTRY_URL }}
          REG_USER: ${{ secrets.REG_USER }}
          REG_PASS: ${{ secrets.REG_PASS }}
        run: |
          echo "$REG_PASS" | docker login -u "$REG_USER" --password-stdin
      - name: Build and push images
        env:
          REGISTRY: ${{ secrets.REGISTRY_URL }}
        run: |
          docker build -t santiagoparraga/microservicea:${{ github.run_number }} microservice-a
          docker push santiagoparraga/microservicea:${{ github.run_number }}
          docker build -t santiagoparraga/microserviceb:${{ github.run_number }} microservice-b
          docker push santiagoparraga/microserviceb:${{ github.run_number }}
          docker build -t santiagoparraga/htmlserver:${{ github.run_number }} html-server
          docker push santiagoparraga/htmlserver:${{ github.run_number }}
      - name: Install OC CLI
        run: |
          curl -L https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-linux.tar.gz | tar xz
          sudo mv oc /usr/local/bin/
          oc version
      - name: Log in Openshift
        uses: redhat-actions/oc-login@v1
        with:
          openshift_server_url: https://api.rm3.7wse.p1.openshiftapps.com:6443
          openshift_token: ${{ secrets.OPENSHIFT_TOKEN }}
      - name: Setup Helm
        uses: azure/setup-helm@v3
      - name: Deploy with Helm
        run: |
          # update values if necessary then deploy
          helm upgrade --install myapp charts/myapp --namespace ${{ secrets.OPENSHIFT_PROJECT }} --create-namespace
